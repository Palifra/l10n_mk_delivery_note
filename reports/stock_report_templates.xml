<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Main Report Template -->
    <template id="report_stock_picking_mk">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="l10n_mk_stock_reports.report_stock_picking_mk_document" t-lang="o.partner_id.lang"/>
            </t>
        </t>
    </template>

    <!-- Document Template - Uses external_layout for Bootstrap CSS and standard header/footer -->
    <template id="report_stock_picking_mk_document">
        <t t-call="web.external_layout">
            <t t-set="o" t-value="o"/>
            <t t-set="company" t-value="o.company_id"/>

            <!-- Force UTF-8 encoding and proper fonts -->
            <style>
                @page {
                    margin: 1cm;
                }
                body {
                    font-family: DejaVu Sans, FreeSans, sans-serif !important;
                }
                .page {
                    font-family: DejaVu Sans, FreeSans, sans-serif !important;
                }
            </style>

            <div class="page" style="font-size: 11px; margin-top: 0; font-family: DejaVu Sans, FreeSans, sans-serif;">
            <!-- Compact Header Row -->
            <div class="row" style="margin-bottom: 10px;">
                <!-- Company Info - Left Side -->
                <div class="col-4">
                    <div style="border: 1px solid #000; padding: 6px; font-size: 10px;">
                        <strong style="font-size: 11px;" t-field="company.name"/>
                        <br/>
                        <span t-field="company.street"/>
                        <t t-if="company.street2">, <span t-field="company.street2"/></t>
                        <br/>
                        <span t-field="company.zip"/> <span t-field="company.city"/>
                        <t t-if="company.vat">
                            <br/>ЕДБ: <span t-field="company.vat"/>
                        </t>
                    </div>
                </div>

                <!-- Document Title and Info - Center -->
                <div class="col-4 text-center" style="padding-left: 3cm;">
                    <h4 style="margin: 0 0 5px 0; text-align: left; font-size: 14px;">
                        <strong>
                            <t t-if="'Реверс' in o.picking_type_id.name and 'Враќање' not in o.picking_type_id.name">РЕВЕРС</t>
                            <t t-elif="'Враќање' in o.picking_type_id.name">ПОВРАТНИЦА</t>
                            <t t-elif="o.picking_type_id.code == 'outgoing'">ИСПРАТНИЦА</t>
                            <t t-elif="o.picking_type_id.code == 'incoming'">ПРИЕМНИЦА</t>
                            <t t-else="">ИСПРАТНИЦА/ПРИЕМНИЦА</t>
                        </strong>
                    </h4>
                    <div style="font-size: 11px; text-align: left;">
                        <strong>Број:</strong> <span t-field="o.name"/><br/>
                        <strong>Датум:</strong> <span t-field="o.scheduled_date" t-options='{"widget": "date"}'/>
                        <t t-if="o.origin">
                            <br/><strong>Извор:</strong> <span t-field="o.origin"/>
                        </t>
                    </div>
                </div>

                <!-- Barcode - Right Side -->
                <div class="col-4 text-center" style="padding-left: 3cm;">
                    <img t-att-src="'/report/barcode/?barcode_type=Code128&amp;value=%s&amp;width=180&amp;height=45' % o.name.replace('/', '')"
                         style="max-width: 100%; height: 45px;" alt="Barcode"/>
                    <br/>
                    <small t-field="o.name"/>
                </div>
            </div>

            <!-- Sender and Receiver - Same Row -->
            <div class="row" style="margin-bottom: 8px;">
                <div class="col-6">
                    <t t-if="o.picking_type_id.code == 'outgoing'">
                        <strong>ИСПРАЌАЧ:</strong>
                        <small>
                            <br/><span t-field="company.name"/>
                            <br/><span t-field="company.street"/>
                            <t t-if="company.street2">, <span t-field="company.street2"/></t>
                            <br/><span t-field="company.zip"/> <span t-field="company.city"/>
                            <t t-if="company.vat"><br/>ЕДБ: <span t-field="company.vat"/></t>
                        </small>
                    </t>
                    <t t-else="">
                        <strong>ДОБАВУВАЧ/ИСПРАЌАЧ:</strong>
                        <t t-if="o.partner_id">
                            <small>
                                <br/><span t-field="o.partner_id.name"/>
                                <t t-if="o.partner_id.street"><br/><span t-field="o.partner_id.street"/></t>
                                <t t-if="o.partner_id.city"><br/><span t-field="o.partner_id.zip"/> <span t-field="o.partner_id.city"/></t>
                                <t t-if="o.partner_id.vat"><br/>ЕДБ: <span t-field="o.partner_id.vat"/></t>
                            </small>
                        </t>
                    </t>
                </div>
                <div class="col-6">
                    <t t-if="o.picking_type_id.code == 'outgoing'">
                        <strong>ПРИМАТЕЛ:</strong>
                        <t t-if="o.partner_id">
                            <small>
                                <br/><span t-field="o.partner_id.name"/>
                                <t t-if="o.partner_id.street"><br/><span t-field="o.partner_id.street"/></t>
                                <t t-if="o.partner_id.city"><br/><span t-field="o.partner_id.zip"/> <span t-field="o.partner_id.city"/></t>
                                <t t-if="o.partner_id.vat"><br/>ЕДБ: <span t-field="o.partner_id.vat"/></t>
                            </small>
                        </t>
                    </t>
                    <t t-else="">
                        <strong>ПРИМАТЕЛ:</strong>
                        <small>
                            <br/><span t-field="company.name"/>
                            <br/><span t-field="company.street"/>
                            <t t-if="company.street2">, <span t-field="company.street2"/></t>
                            <br/><span t-field="company.zip"/> <span t-field="company.city"/>
                            <t t-if="company.vat"><br/>ЕДБ: <span t-field="company.vat"/></t>
                        </small>
                    </t>
                </div>
            </div>

            <!-- Products Table - Very Compact -->
            <table class="table table-sm table-bordered" style="border: 1px solid #000; font-size: 10px; margin-bottom: 5px;">
                <thead>
                    <tr style="background-color: #e0e0e0;">
                        <th class="text-center" style="width: 4%; padding: 2px;">Бр.</th>
                        <th class="text-center" style="width: 12%; padding: 2px;">Шифра</th>
                        <th style="width: 54%; padding: 2px;">Назив на артикл</th>
                        <th class="text-center" style="width: 15%; padding: 2px;">Количина</th>
                        <th class="text-center" style="width: 15%; padding: 2px;">ЕМ</th>
                    </tr>
                </thead>
                <tbody>
                    <t t-set="line_num" t-value="0"/>
                    <t t-set="total_lines" t-value="len(o.move_ids.filtered(lambda m: m.state != 'cancel'))"/>
                    <t t-foreach="o.move_ids.filtered(lambda m: m.state != 'cancel')" t-as="move">
                        <t t-set="line_num" t-value="line_num + 1"/>
                        <tr style="line-height: 1.1;">
                            <td class="text-center" t-att-style="'padding: 1px;' + (' border-bottom: 1px solid #000;' if line_num == total_lines else '')"><span t-esc="line_num"/></td>
                            <td class="text-center" t-att-style="'padding: 1px;' + (' border-bottom: 1px solid #000;' if line_num == total_lines else '')"><span t-field="move.product_id.default_code"/></td>
                            <td t-att-style="'padding: 1px;' + (' border-bottom: 1px solid #000;' if line_num == total_lines else '')"><span t-field="move.product_id.name"/></td>
                            <td class="text-center" t-att-style="'padding: 1px;' + (' border-bottom: 1px solid #000;' if line_num == total_lines else '')"><span t-field="move.quantity" t-options='{"widget": "float", "precision": 2}'/></td>
                            <td class="text-center" t-att-style="'padding: 1px;' + (' border-bottom: 1px solid #000;' if line_num == total_lines else '')"><span t-field="move.product_uom.name"/></td>
                        </tr>
                    </t>
                </tbody>
            </table>

            <!-- Notes -->
            <t t-if="o.note">
                <div style="margin-bottom: 5px;">
                    <small><strong>Забелешка:</strong> <span t-field="o.note"/></small>
                </div>
            </t>

            <!-- Signatures - Compact -->
            <div class="row" style="margin-top: 2cm; page-break-inside: avoid;">
                <div class="col-4 text-center">
                    <div style="border-top: 1px solid #000; padding-top: 2px; margin-top: 25px;">
                        <small><strong>ИЗДАЛ</strong><br/>(потпис и печат)</small>
                    </div>
                </div>
                <div class="col-4 text-center">
                    <div style="border-top: 1px solid #000; padding-top: 2px; margin-top: 25px;">
                        <small><strong>ПРИМИЛ</strong><br/>(потпис и печат)</small>
                    </div>
                </div>
                <div class="col-4 text-center">
                    <div style="border-top: 1px solid #000; padding-top: 2px; margin-top: 25px;">
                        <small><strong>Овластено лице</strong><br/>(потпис)</small>
                    </div>
                </div>
            </div>

            <!-- Footer is provided by external_layout -->

        </div>
        </t>
    </template>

</odoo>
